amethyst Renamer2 < Traverser {
	root = Rule[{@@newvars={}} traverse]
	
	visit = Local[ :name @this:this ]  -> @@newvars[this] ? @@newvars[this] : ($av+=1; @@newvars[this]=_Local(name,$av) ;@@newvars[this] )
}

amethyst DetectCalls < Traverser {
	root = Rule[{@@calls={}} traverse {@@calls} ]
	
	visit = Apply[:name .*:args {@@calls[name]=true } @this]
}

amethyst Inliner2 < Traverser {
	
	root = :from :to {from}=>Rule[@name:name @args:args @locals:locals @body:body]  {@@result=autovar;@@name=name;@@args=args;@@body=Set[{:name=>@@result ,:expr=>body}] } 
				 {to}=>Rule[traverse]
 
 visit = Apply[:name &{name==@@name} .*:args] ->  body=@@body; args.each_index{|i| body=Seq[Set[{:name=>@@args[i],:expr=>Act[args[i]]}],body] } ; Seq[body,Act[@@result]]
}
