amethyst Analyze_Variables2 < Traverser {
  root = @this=>Rule[  {@@variables=Hash.new{|k,v| k[v]=v} ;(@locals+@args).each{|v| @@variables[v[0]]=v}} {@@locals=@locals} traverse  {@this.body=And[{:ary=>((@locals-@args).map{|v| Set[{:name=>v,:expr=>Act["nil"],:append=>false}]}+[@body]) }]} @this]

	visit = Args[ traverse {@this.ary=@ary.map{|a| @@variables[a] }}  @this]
				|  Result[ {@this.vars=@@locals.select{|a| a[0]!= "autovar"&&a[0]!="_result"&&a[0]!="it"}.uniq} traverse]
}
